[Ubuntu note: removed src/Changelog changes, as they are not needed to fix
 the issue considered by CVE-2021-33294.
 -- Camila Camargo de Matos <camila.camargodematos@canonical.com>]

Origin: backport, https://sourceware.org/git/?p=elfutils.git;a=commit;h=480b6fa3662ba8ffeee274bf0d37423413c01e55

From 480b6fa3662ba8ffeee274bf0d37423413c01e55 Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mark@klomp.org>
Date: Wed, 3 Mar 2021 21:40:53 +0100
Subject: [PATCH] readelf: Sanity check verneed and verdef offsets in
 handle_symtab.

We are going through vna_next, vn_next and vd_next in a while loop.
Make sure that all offsets are sane. We don't want things to wrap
around so we go in cycles.

https://sourceware.org/bugzilla/show_bug.cgi?id=27501

Signed-off-by: Mark Wielaard <mark@klomp.org>
---
 src/ChangeLog |  5 +++++
 src/readelf.c | 10 +++++++++-
 2 files changed, 14 insertions(+), 1 deletion(-)

Index: elfutils-0.176/src/readelf.c
===================================================================
--- elfutils-0.176.orig/src/readelf.c
+++ elfutils-0.176/src/readelf.c
@@ -2515,7 +2515,9 @@ handle_symtab (Ebl *ebl, Elf_Scn *scn, G
 						 &vernaux_mem);
 		      while (vernaux != NULL
 			     && vernaux->vna_other != *versym
-			     && vernaux->vna_next != 0)
+			     && vernaux->vna_next != 0
+			     && (verneed_data->d_size - vna_offset
+				 >= vernaux->vna_next))
 			{
 			  /* Update the offset.  */
 			  vna_offset += vernaux->vna_next;
@@ -2532,6 +2534,9 @@ handle_symtab (Ebl *ebl, Elf_Scn *scn, G
 			/* Found it.  */
 			break;
 
+		      if (verneed_data->d_size - vn_offset < verneed->vn_next)
+			break;
+
 		      vn_offset += verneed->vn_next;
 		      verneed = (verneed->vn_next == 0
 				 ? NULL
@@ -2567,6 +2572,9 @@ handle_symtab (Ebl *ebl, Elf_Scn *scn, G
 			/* Found the definition.  */
 			break;
 
+		      if (verdef_data->d_size - vd_offset < verdef->vd_next)
+			break;
+
 		      vd_offset += verdef->vd_next;
 		      verdef = (verdef->vd_next == 0
 				? NULL
